<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <title>Gerador de URL para Google Calendar</title>
  <style>
    :root{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{max-width:920px;margin:32px auto;padding:18px;font-size:16px;color:#111}
    h1{font-size:1.4rem;margin:0 0 12px}
    label{display:block;margin-top:10px;font-weight:600}
    textarea,input,select{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:15px}
    textarea{min-height:150px;resize:vertical}
    .row{display:flex;gap:12px}
    .col{flex:1}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:white;cursor:pointer}
    .actions{display:flex;gap:8px;align-items:center}
    .output{margin-top:12px;padding:10px;border-radius:8px;background:#f3f4f6;border:1px solid #e5e7eb;word-break:break-all}
    .hint{font-size:13px;color:#555;margin-top:6px}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <h1>Gerador de URL para Google Calendar</h1>
  <p class="small">Cole um texto de convite no bloco abaixo e clique em <strong>Extrair</strong> (melhor esfor√ßo). Ajuste os campos se necess√°rio e clique em <strong>Gerar URL</strong>.</p>

  <label for="raw">Colar texto do convite / mensagem</label>
  <textarea id="raw" placeholder="Cole aqui o texto do convite, por exemplo:\nPr√© Wedding Fl√°&Lipe üíê\nData: 28/12\nLocal: Rua Bento Martins, 175, Alvorada\n..." ></textarea>
  <div class="actions">
    <button id="parseBtn">Extrair do texto</button>
    <button id="clearBtn" style="background:#ef4444">Limpar</button>
  </div>

  <label for="title">T√≠tulo do evento</label>
  <input id="title" placeholder="T√≠tulo do evento" />

  <div class="row">
    <div class="col">
      <label for="start">Data / In√≠cio</label>
      <input id="start" type="datetime-local" />
    </div>
    <div class="col">
      <label for="end">Data / Fim</label>
      <input id="end" type="datetime-local" />
    </div>
  </div>

  <label for="allDay"><input id="allDay" type="checkbox" /> Evento o dia todo (all-day)</label>

  <label for="location">Local (endere√ßo)</label>
  <input id="location" placeholder="Rua, n√∫mero, cidade" />

  <label for="details">Descri√ß√£o / Detalhes</label>
  <textarea id="details" placeholder="Coloque aqui a descri√ß√£o que ir√° para o campo 'detalhes' do Google Calendar"></textarea>

  <label for="ctz">Fuso hor√°rio (ctz)</label>
  <select id="ctz">
    <option value="America/Sao_Paulo" selected>America/Sao_Paulo</option>
    <option value="UTC">UTC</option>
  </select>

  <div class="actions">
    <button id="gen">Gerar URL</button>
    <button id="open" style="background:#10b981">Abrir no Calendar</button>
    <button id="copy" style="background:#6b7280">Copiar URL</button>
  </div>

  <div class="output" id="out">URL gerada aparecer√° aqui</div>

  <script>
    // util: format Date -> Google format (UTC Z)
    function pad(n, width=2){return String(n).padStart(width,'0')}
    function toGoogleDateTimeUTC(d, allDay){
      if(!d) return ''
      if(allDay){
        // return YYYYMMDD (local date used)
        return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())
      }
      return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'Z'
    }

    function encode(s){return encodeURIComponent(s||'')}

    function buildUrl(opts){
      const base = 'https://calendar.google.com/calendar/u/0/r/eventedit'
      const text = opts.title || ''
      const loc = opts.location || ''
      const details = opts.details || ''
      const ctz = opts.ctz || 'America/Sao_Paulo'
      const dates = opts.allDay ? (opts.startDateStr + '/' + opts.endDateStr) : (opts.startUTC + '/' + opts.endUTC)
      const params = `?text=${encode(text)}&dates=${dates}&details=${encode(details)}&location=${encode(loc)}&ctz=${encode(ctz)}`
      return base + params
    }

    // UI bindings
    const raw = document.getElementById('raw')
    const parseBtn = document.getElementById('parseBtn')
    const clearBtn = document.getElementById('clearBtn')
    const titleEl = document.getElementById('title')
    const startEl = document.getElementById('start')
    const endEl = document.getElementById('end')
    const locationEl = document.getElementById('location')
    const detailsEl = document.getElementById('details')
    const ctzEl = document.getElementById('ctz')
    const genBtn = document.getElementById('gen')
    const out = document.getElementById('out')
    const copyBtn = document.getElementById('copy')
    const openBtn = document.getElementById('open')
    const allDayEl = document.getElementById('allDay')

    clearBtn.addEventListener('click', ()=>{
      raw.value=''; titleEl.value=''; startEl.value=''; endEl.value=''; locationEl.value=''; detailsEl.value=''; out.textContent='URL gerada aparecer√° aqui'
    })

    // try to extract title/date/location/description from pasted text (best effort)
    parseBtn.addEventListener('click', ()=>{
      const text = raw.value.trim()
      if(!text) return alert('Cole o texto do convite primeiro.')
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean)
      // title: first line
      titleEl.value = lines[0] || ''
      // details: full text
      detailsEl.value = text
      // find date (dd/mm or dd/mm/yyyy)
      const dateRegex = /(\b\d{1,2}\/\d{1,2}(?:\/\d{2,4})?\b)/
      let foundDate = null
      for(const l of lines){
        const m = l.match(dateRegex)
        if(m){ foundDate = m[1]; break }
      }
      // try to find time like HH:MM or hH
      const timeRegex = /(\b\d{1,2}:\d{2}\b)/
      let foundTime = null
      for(const l of lines){
        const m = l.match(timeRegex)
        if(m){ foundTime = m[1]; break }
      }
      // location: line starting with Local or containing Rua/Avenida
      let foundLoc = ''
      for(const l of lines){
        if(/^Local[:\s]/i.test(l) || /\bRua\b|\bAvenida\b|\bAv\b|\bR\.|\bAlameda\b/i.test(l)){
          foundLoc = l.replace(/^Local[:\s-]*/i,'')
          break
        }
      }
      if(foundLoc) locationEl.value = foundLoc

      // set start/end inputs
      const now = new Date()
      const yearNow = now.getFullYear()
      if(foundDate){
        // parse dd/mm or dd/mm/yyyy
        const parts = foundDate.split('/')
        let d = parseInt(parts[0],10)
        let m = parseInt(parts[1],10)
        let y = parts[2] ? parseInt(parts[2],10) : yearNow
        if(y < 100) y += 2000
        // if date already passed this year and no year provided, assume next year
        if(!parts[2]){
          const cand = new Date(y, m-1, d)
          if(cand < now) y = y + 1
        }
        // time
        let hh = 11, mm = 0
        if(foundTime){ const tparts = foundTime.split(':'); hh = parseInt(tparts[0],10); mm = parseInt(tparts[1],10) }
        const startDate = new Date(y, m-1, d, hh, mm, 0)
        // default end 4 hours later
        const endDate = new Date(startDate.getTime() + 4*60*60*1000)
        // set inputs value in local datetime format YYYY-MM-DDTHH:MM
        function localInputVal(dt){
          const s = dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes())
          return s
        }
        startEl.value = localInputVal(startDate)
        endEl.value = localInputVal(endDate)
      } else {
        // no date found: leave blank but set default today 11:00
        const s = new Date(); s.setHours(11,0,0,0)
        const e = new Date(s.getTime() + 4*60*60*1000)
        function localInputVal(dt){
          const s = dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes())
          return s
        }
        startEl.value = localInputVal(s)
        endEl.value = localInputVal(e)
      }

      alert('Extra√ß√£o conclu√≠da. Ajuste os campos se necess√°rio e clique em "Gerar URL".')
    })

    genBtn.addEventListener('click', ()=>{
      const title = titleEl.value || 'Evento'
      const location = locationEl.value
      const details = detailsEl.value
      const ctz = ctzEl.value
      const allDay = allDayEl.checked
      if(!startEl.value){ return alert('Preencha a data/hora de in√≠cio.') }
      if(!endEl.value){ return alert('Preencha a data/hora de t√©rmino.') }
      const startDate = new Date(startEl.value)
      const endDate = new Date(endEl.value)
      let startUTC = toGoogleDateTimeUTC(startDate, allDay)
      let endUTC = toGoogleDateTimeUTC(endDate, allDay)
      let startDateStr = '', endDateStr = ''
      if(allDay){
        // Google expects end date to be the day after for all-day multi-day events; but we'll use given end date as inclusive and add +1 day to end
        const sd = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate())
        const ed = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate())
        // make end exclusive
        ed.setDate(ed.getDate()+1)
        startDateStr = toGoogleDateTimeUTC(sd, true)
        endDateStr = toGoogleDateTimeUTC(ed, true)
      }
      const opts = {
        title, location, details, ctz, allDay,
        startUTC, endUTC, startDateStr, endDateStr
      }
      const url = buildUrl(opts)
      out.textContent = url
      out.dataset.url = url
    })

    copyBtn.addEventListener('click', async ()=>{
      const url = out.dataset.url
      if(!url) return alert('Gere a URL primeiro.')
      try{ await navigator.clipboard.writeText(url); alert('URL copiada para a √°rea de transfer√™ncia!') } catch(e){ prompt('Copie manualmente:', url) }
    })

    openBtn.addEventListener('click', ()=>{
      const url = out.dataset.url
      if(!url) return alert('Gere a URL primeiro.')
      window.open(url, '_blank')
    })

  </script>
  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./sw.js")
        .then(() => console.log("‚úÖ Service Worker registrado."))
        .catch((err) => console.error("Service Worker erro:", err));
    });
  }
</script>

</body>
</html>
