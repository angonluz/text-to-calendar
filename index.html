<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de URL para Google Calendar</title>
  <style>
    :root{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{max-width:920px;margin:32px auto;padding:18px;font-size:16px;color:#111}
    h1{font-size:1.4rem;margin:0 0 12px}
    label{display:block;margin-top:10px;font-weight:600}
    textarea,input,select{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:15px}
    textarea{min-height:150px;resize:vertical}
    .row{display:flex;gap:12px}
    .col{flex:1}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:white;cursor:pointer}
    .actions{display:flex;gap:8px;align-items:center}
    .output{margin-top:12px;padding:10px;border-radius:8px;background:#f3f4f6;border:1px solid #e5e7eb;word-break:break-all}
    .hint{font-size:13px;color:#555;margin-top:6px}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <h1>Gerador de URL para Google Calendar</h1>
  <p class="small">Cole um texto de convite no bloco abaixo e clique em <strong>Extrair</strong> (melhor esfor√ßo). Ajuste os campos se necess√°rio e clique em <strong>Gerar URL</strong>.</p>

  <label for="raw">Colar texto do convite / mensagem</label>
  <textarea id="raw" placeholder="Cole aqui o texto do convite, por exemplo:\nPr√© Wedding Fl√°&Lipe üíê\nData: 28/12\nLocal: Rua Bento Martins, 175, Alvorada\n..." ></textarea>
  <div class="actions">
    <button id="parseBtn">Extrair do texto</button>
    <button id="clearBtn" style="background:#ef4444">Limpar</button>
  </div>

  <label for="title">T√≠tulo do evento</label>
  <input id="title" placeholder="T√≠tulo do evento" />

  <div class="row">
    <div class="col">
      <label for="start">Data / In√≠cio</label>
      <input id="start" type="datetime-local" />
    </div>
    <div class="col">
      <label for="end">Data / Fim</label>
      <input id="end" type="datetime-local" />
    </div>
  </div>

  <label for="allDay"><input id="allDay" type="checkbox" /> Evento o dia todo (all-day)</label>

  <label for="location">Local (endere√ßo)</label>
  <input id="location" placeholder="Rua, n√∫mero, cidade" />

  <label for="details">Descri√ß√£o / Detalhes</label>
  <textarea id="details" placeholder="Coloque aqui a descri√ß√£o que ir√° para o campo 'detalhes' do Google Calendar"></textarea>

  <label for="ctz">Fuso hor√°rio (ctz)</label>
  <select id="ctz">
    <option value="America/Sao_Paulo" selected>America/Sao_Paulo</option>
    <option value="UTC">UTC</option>
  </select>

  <div class="actions">
    <button id="gen">Gerar URL</button>
    <button id="open" style="background:#10b981">Abrir no Calendar</button>
    <button id="copy" style="background:#6b7280">Copiar URL</button>
  </div>

  <div class="output" id="out">URL gerada aparecer√° aqui</div>

  <script>
    // util: format Date -> Google format (UTC Z)
    function pad(n, width=2){return String(n).padStart(width,'0')}
    function toGoogleDateTimeUTC(d, allDay){
      if(!d) return ''
      if(allDay){
        // return YYYYMMDD (local date used)
        return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())
      }
      return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'Z'
    }

    function encode(s){return encodeURIComponent(s||'')}

    function buildUrl(opts){
      const base = 'https://calendar.google.com/calendar/u/0/r/eventedit'
      const text = opts.title || ''
      const loc = opts.location || ''
      const details = opts.details || ''
      const ctz = opts.ctz || 'America/Sao_Paulo'
      const dates = opts.allDay ? (opts.startDateStr + '/' + opts.endDateStr) : (opts.startUTC + '/' + opts.endUTC)
      const params = `?text=${encode(text)}&dates=${dates}&details=${encode(details)}&location=${encode(loc)}&ctz=${encode(ctz)}`
      return base + params
    }

    // UI bindings
    const raw = document.getElementById('raw')
    const parseBtn = document.getElementById('parseBtn')
    const clearBtn = document.getElementById('clearBtn')
    const titleEl = document.getElementById('title')
    const startEl = document.getElementById('start')
    const endEl = document.getElementById('end')
    const locationEl = document.getElementById('location')
    const detailsEl = document.getElementById('details')
    const ctzEl = document.getElementById('ctz')
    const genBtn = document.getElementById('gen')
    const out = document.getElementById('out')
    const copyBtn = document.getElementById('copy')
    const openBtn = document.getElementById('open')
    const allDayEl = document.getElementById('allDay')

    clearBtn.addEventListener('click', ()=>{
      raw.value=''; titleEl.value=''; startEl.value=''; endEl.value=''; locationEl.value=''; detailsEl.value=''; out.textContent='URL gerada aparecer√° aqui'
    })

    // try to extract title/date/location/description from pasted text (best effort)
    parseBtn.addEventListener('click', async () => {
      const text = raw.value.trim();
      if (!text) return alert("Cole o texto do evento primeiro.");
    
      out.textContent = "Analisando texto com IA (Gemini via Cloudflare)... aguarde ‚è≥";
    
      try {
        const resp = await fetch("https://SEUWORKER.subdomain.workers.dev", { // substitua pela URL do Worker
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
    
        if (!resp.ok) throw new Error("Erro: " + resp.status);
        const data = await resp.json();
    
        titleEl.value = data.title || "";
        locationEl.value = data.location || "";
        detailsEl.value = data.details || text;
    
        if (data.date) {
          const start = data.start_time || "11:00";
          const end = data.end_time || "15:00";
          startEl.value = `${data.date}T${start}`;
          endEl.value = `${data.date}T${end}`;
        }
    
        out.textContent = "Extra√ß√£o conclu√≠da com sucesso ‚úÖ";
      } catch (err) {
        console.error(err);
        out.textContent = "Erro ao usar o Gemini.";
      }
    });


    genBtn.addEventListener('click', ()=>{
      const title = titleEl.value || 'Evento'
      const location = locationEl.value
      const details = detailsEl.value
      const ctz = ctzEl.value
      const allDay = allDayEl.checked
      if(!startEl.value){ return alert('Preencha a data/hora de in√≠cio.') }
      if(!endEl.value){ return alert('Preencha a data/hora de t√©rmino.') }
      const startDate = new Date(startEl.value)
      const endDate = new Date(endEl.value)
      let startUTC = toGoogleDateTimeUTC(startDate, allDay)
      let endUTC = toGoogleDateTimeUTC(endDate, allDay)
      let startDateStr = '', endDateStr = ''
      if(allDay){
        // Google expects end date to be the day after for all-day multi-day events; but we'll use given end date as inclusive and add +1 day to end
        const sd = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate())
        const ed = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate())
        // make end exclusive
        ed.setDate(ed.getDate()+1)
        startDateStr = toGoogleDateTimeUTC(sd, true)
        endDateStr = toGoogleDateTimeUTC(ed, true)
      }
      const opts = {
        title, location, details, ctz, allDay,
        startUTC, endUTC, startDateStr, endDateStr
      }
      const url = buildUrl(opts)
      out.textContent = url
      out.dataset.url = url
    })

    copyBtn.addEventListener('click', async ()=>{
      const url = out.dataset.url
      if(!url) return alert('Gere a URL primeiro.')
      try{ await navigator.clipboard.writeText(url); alert('URL copiada para a √°rea de transfer√™ncia!') } catch(e){ prompt('Copie manualmente:', url) }
    })

    openBtn.addEventListener('click', ()=>{
      const url = out.dataset.url
      if(!url) return alert('Gere a URL primeiro.')
      window.open(url, '_blank')
    })

  </script>
</body>
</html>
